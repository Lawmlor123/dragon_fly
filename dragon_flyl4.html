<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="screen-orientation" content="portrait">
<meta name="orientation" content="portrait">
<title>Dragon Adventure ‚Äì Level 4 (Mobile Scaled, Fixed for iPhone)</title>
<style>
  html,body{margin:0;overflow:hidden;background:#87ceeb;}
  canvas{display:block;z-index:0;}
  #instructions{
    position:absolute;top:10px;left:10px;
    color:#fff;font-family:sans-serif;
    background:rgba(0,0,0,0.55);
    padding:10px 14px;border-radius:12px;
    font-size:16px;line-height:1.4;max-width:380px;
    z-index:5;
  }
  #scoreBoard,#timerBoard{
    position:absolute;right:10px;
    background:rgba(255,255,255,0.6);border-radius:8px;
    padding:6px 14px;font-family:sans-serif;color:#222;z-index:5;
  }
  #scoreBoard{top:10px;font-size:20px;}
  #timerBoard{top:45px;font-size:18px;}
  #winOverlay{
    position:absolute;display:none;
    top:50%;left:50%;transform:translate(-50%,-50%);
    text-align:center;color:#e74c3c;
    background:rgba(255,255,255,0.95);
    padding:30px 40px;border-radius:20px;
    font-family:sans-serif;z-index:10;
    width: 80%; max-width: 400px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  }
  #winOverlay h1{font-size:40px;margin:0 0 15px;}
  #winOverlay button{
    font-size:20px;margin:8px;padding:10px 20px;
    border:none;border-radius:8px;cursor:pointer;
    background:#f39c12;color:#fff;width:100%;
  }
  #winOverlay button:hover{background:#e67e22;}
  #mobileControls{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    display:flex;gap:20px;z-index:30;
  }
  #mobileControls button{
    width:80px;height:80px;border-radius:50%;border:none;
    background:rgba(0,0,0,0.5);color:#fff;font-size:40px;
    user-select:none;backdrop-filter:blur(4px);
  }
  #mobileControls button:active{background:rgba(255,255,255,0.4);color:yellow;}
  @media(min-width:1100px){#mobileControls{display:none;}}
</style>
</head>
<body>

<div id="instructions">
 üêâ <b>How to Play:</b><br/>
 ‚Ä¢ Tap arrows to move.<br/>
 ‚Ä¢ Tap & hold anywhere to fly & shoot!<br/>
 Reach 1500 pts to win!
</div>

<div id="scoreBoard">Score: 0</div>
<div id="timerBoard">Time: 0.0 s</div>
<div id="winOverlay"></div>
<audio id="bgMusic" src="Music/Chase.mp3" loop preload="auto"></audio>
<canvas id="game"></canvas>

<div id="mobileControls">
  <button id="leftBtn">‚Æú</button>
  <button id="rightBtn">‚Æû</button>
</div>

<script>
/* ========= GLOBAL SCALE ========= */
const isMobile = Math.min(window.innerWidth, window.innerHeight) < 750;
const SCALE = isMobile ? 0.55 : 1.0;
const S = v => v * SCALE;

/* ====================== GAME INITIALIZATION ====================== */
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");

/* ----- iPhone Safe Canvas Resize Fix ----- */
let cssHeight = window.innerHeight;
function resize() {
  const width = window.innerWidth;
  cssHeight = Math.min(document.documentElement.clientHeight, window.innerHeight);

  canvas.width  = width * window.devicePixelRatio;
  canvas.height = cssHeight * window.devicePixelRatio;

  // Scale drawing context for high DPI and align coordinates to CSS pixels
  ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
}
resize();
window.addEventListener("resize", resize);
/* ---------------------------------------- */

const music=document.getElementById("bgMusic");
let musicPlaying=false;
function startMusic(){if(!musicPlaying){music.volume=0.25;music.play().catch(()=>{});musicPlaying=true;}}
addEventListener("keydown",startMusic);
addEventListener("touchstart",startMusic);

const scoreBoard=document.getElementById("scoreBoard");
const timerBoard=document.getElementById("timerBoard");
const winOverlay=document.getElementById("winOverlay");

const groundH=S(80), groundY=()=>cssHeight-groundH;

let camX=0,score=0;
const POINTS_PER_HAZARD=100,WIN_SCORE=1500;
let startTime=null,elapsed=0,timerRunning=false;
const BEST_KEY="dragonL4_bestTime";

function startTimerIfNeeded(){if(!timerRunning){startTime=performance.now();timerRunning=true;}}
addEventListener("keydown",startTimerIfNeeded);
addEventListener("touchstart",startTimerIfNeeded);

let dragon={x:S(200),y:groundY()-S(60),radius:S(60),vx:0,vy:0};
const keys={};
addEventListener("keydown",e=>keys[e.code]=true);
addEventListener("keyup",e=>keys[e.code]=false);

let fireballs=[];
function shootFireball(){
  fireballs.push({
    x:dragon.x+dragon.radius*1.4,
    y:dragon.y-S(8),
    vx:S(12),
    life:80
  });
}
addEventListener("keydown",e=>{if(e.code==="Space")shootFireball();});
canvas.addEventListener("touchstart",()=>{keys.Space=true;shootFireball();});
canvas.addEventListener("touchend",()=>{keys.Space=false;});

/* ====================== HAZARDS ====================== */
let hazards=[],currentHazardIndex=0;
createHazards();

function createHazards(){
  hazards=[];
  let posX=S(1000);
  const baseSpacing = isMobile ? 250 : 500;
  const randomSpacing = isMobile ? 150 : 300;

  for(let i=0;i<20;i++){
    hazards.push(makeHazard(posX));
    posX += S(baseSpacing + Math.random()*randomSpacing);
  }
  currentHazardIndex=0;
}

function makeHazard(x){
  const t=["house","rock","tower","tree"][Math.floor(Math.random()*4)];
  const colors={house:["#ffcc66","#aa3333"],
                rock:["#6b4f3a","#8b6d5c"],
                tower:["#bebebe","#8b8b8b"],
                tree:["#228b22","#006400"]};
  const c=colors[t];
  return{
    type:t,
    x,
    y:groundY()-S(60),
    w:S(80+Math.random()*40),
    h:S(90+Math.random()*40),
    hits:3,
    alive:true,
    flames:[],
    bodyColor:c[0],
    roofColor:c[1]
  };
}

/* ====================== UPDATE LOOP ====================== */
function update(){
  const spd=S(6), g=S(0.8), lift=S(1.2), maxUp=S(-10), maxDn=S(15);

  dragon.vx=0;
  if(keys["ArrowLeft"]||keys["KeyA"])dragon.vx=-spd;
  if(keys["ArrowRight"]||keys["KeyD"])dragon.vx=spd;
  dragon.x+=dragon.vx;

  if(keys.Space){
    dragon.vy-=lift;
    if(dragon.vy<maxUp)dragon.vy=maxUp;
  } else {
    dragon.vy+=g;
    if(dragon.vy>maxDn)dragon.vy=maxDn;
  }
  dragon.y+=dragon.vy;

  const gL=groundY()-dragon.radius;
  if(dragon.y>gL){dragon.y=gL;dragon.vy=0;}

  camX=dragon.x-canvas.width/window.devicePixelRatio*0.3;
  if(camX<0)camX=0;

  for(let i=fireballs.length-1;i>=0;i--){
    const f=fireballs[i];
    f.x+=f.vx; f.life--;
    if(f.life<=0){fireballs.splice(i,1);continue;}

    for(const h of hazards){
      if(!h.alive)continue;
      if(f.x>h.x-h.w/2&&f.x<h.x+h.w/2&&f.y>h.y-h.h&&f.y<h.y){
        h.hits--;fireballs.splice(i,1);
        if(h.hits<=0)destroyHazard(h);
        break;
      }
    }
  }

  for(const h of hazards){
    for(const fl of h.flames){
      fl.life--;
      fl.size+=S(0.6);
      fl.y-=S(0.8);
      fl.opacity=Math.max(0,fl.life/30);
    }
    h.flames=h.flames.filter(f=>f.life>0);
  }

  const active=hazards[currentHazardIndex];
  if(active&&!active.alive&&active.flames.length===0)currentHazardIndex++;

  if(timerRunning){
    elapsed=(performance.now()-startTime)/1000;
    timerBoard.textContent=`Time: ${elapsed.toFixed(1)} s`;
  }

  draw();
  requestAnimationFrame(update);
}

function destroyHazard(h){
  h.alive=false;h.flames=[];
  score+=POINTS_PER_HAZARD;
  scoreBoard.textContent=`Score: ${score}`;
  if(score>=WIN_SCORE){levelWin();}

  for(let i=0;i<30;i++){
    h.flames.push({
      x:h.x+(Math.random()-0.5)*h.w,
      y:h.y-Math.random()*h.h,
      size:S(10+Math.random()*10),
      life:30+Math.random()*10,
      opacity:1
    });
  }
}

/* ====================== WIN ====================== */
function levelWin(){
  timerRunning=false;
  const finalTime=elapsed;
  let best=localStorage.getItem(BEST_KEY);
  if(!best||finalTime<parseFloat(best)){
    best=finalTime;localStorage.setItem(BEST_KEY,best);
  }
  music.pause();music.currentTime=0;
  winOverlay.style.display="block";
  winOverlay.innerHTML=
  `<h1>üèÜ You Win! üèÜ</h1>
   <div>Time: ${finalTime.toFixed(1)} s<br>(Best: ${parseFloat(best).toFixed(1)} s)</div>
   <button id="playAgainBtn">Play Again</button>
   <button id="nextLevelBtn">Level 5 ‚Üí</button>`;

  document.getElementById("playAgainBtn").onclick=()=>{
    winOverlay.style.display="none";
    score=0;
    scoreBoard.textContent="Score: 0";
    fireballs=[];
    createHazards();
    elapsed=0;
    timerBoard.textContent="Time: 0.0 s";
    timerRunning=false;
    startTime=null;

    dragon.x=S(200);dragon.y=groundY()-S(60);
    dragon.vx=dragon.vy=0;

    music.currentTime=0;music.play();musicPlaying=true;
  };

  document.getElementById("nextLevelBtn").onclick=
    ()=>window.location.href="dragon_flyl5full.html";
}

/* ====================== DRAWING ====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const heightCSS = cssHeight;
  const skyGrad=ctx.createLinearGradient(0,0,0,heightCSS);
  skyGrad.addColorStop(0,"#87ceeb");
  skyGrad.addColorStop(1,"#4ca3dd");
  ctx.fillStyle=skyGrad;
  ctx.fillRect(0,0,canvas.width/window.devicePixelRatio,heightCSS);

  const tileW=S(200);
  ctx.fillStyle="#2e8b57";
  for(let gx=-(camX%tileW);gx<canvas.width/window.devicePixelRatio;gx+=tileW){
    ctx.fillRect(gx,groundY(),tileW,groundH);
  }

  for(const h of hazards){
    const drawX=h.x-camX;
    if(drawX+h.w<0||drawX-h.w>canvas.width/window.devicePixelRatio)continue;

    if(h.alive)drawHazard(h,drawX);

    for(const f of h.flames){
      const g=ctx.createRadialGradient(f.x-camX,f.y,S(2),f.x-camX,f.y,f.size);
      g.addColorStop(0,`rgba(255,255,150,${f.opacity})`);
      g.addColorStop(0.4,`rgba(255,120,0,${f.opacity})`);
      g.addColorStop(1,`rgba(255,0,0,0)`);
      ctx.fillStyle=g;
      ctx.beginPath();
      ctx.arc(f.x-camX,f.y,f.size,0,Math.PI*2);
      ctx.fill();
    }
  }

  for(const f of fireballs){
    const drawX=f.x-camX;
    const grd=ctx.createRadialGradient(drawX,f.y,S(2),drawX,f.y,S(12));
    grd.addColorStop(0,"#ffff99");
    grd.addColorStop(0.4,"#ff9900");
    grd.addColorStop(1,"rgba(255,85,0,0)");
    ctx.fillStyle=grd;
    ctx.beginPath();
    ctx.arc(drawX,f.y,S(12),0,Math.PI*2);
    ctx.fill();
  }

  drawDragon(dragon.x-camX);
}

function drawDragon(drawX){
  const r=dragon.radius;
  const grad=ctx.createLinearGradient(drawX-S(40),dragon.y-S(40),drawX+S(40),dragon.y+S(40));
  grad.addColorStop(0,"#e74c3c");
  grad.addColorStop(1,"#f39c12");
  ctx.fillStyle=grad;

  ctx.beginPath();
  ctx.ellipse(drawX,dragon.y,r,r*0.7,0,0,Math.PI*2);
  ctx.fill();

  ctx.strokeStyle="#f39c12";
  ctx.lineWidth=S(10);
  ctx.beginPath();
  const tailWiggle=Math.sin(Date.now()/150)*S(10);
  ctx.moveTo(drawX-r*1.5,dragon.y+tailWiggle);
  ctx.lineTo(drawX-r*3.0,dragon.y+tailWiggle*0.5);
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(drawX+r*0.9,dragon.y-S(8),S(25),0,Math.PI*2);
  ctx.fillStyle=grad;
  ctx.fill();

  ctx.fillStyle="#f1c40f";
  ctx.beginPath();
  ctx.moveTo(drawX+r*0.8,dragon.y-S(28));
  ctx.lineTo(drawX+r*1.1,dragon.y-S(48));
  ctx.lineTo(drawX+r*1.3,dragon.y-S(28));
  ctx.closePath();
  ctx.fill();

  ctx.save();
  ctx.translate(drawX,dragon.y);
  ctx.rotate(Math.sin(Date.now()/180)*0.4);
  ctx.fillStyle="#f1c40f";
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.quadraticCurveTo(S(-80),S(-50),S(-120),0);
  ctx.quadraticCurveTo(S(-80),S(50),0,0);
  ctx.fill();
  ctx.restore();

  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.arc(drawX+r,dragon.y-S(12),S(8),0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="#000";
  ctx.beginPath();
  ctx.arc(drawX+r,dragon.y-S(12),S(3),0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="#c0392b";
  ctx.beginPath();
  ctx.ellipse(drawX+r*1.25,dragon.y-S(6),S(10),S(6),0,0,Math.PI*2);
  ctx.fill();
}

function drawHazard(h,drawX){
  switch(h.type){
    case"house":
      ctx.fillStyle=h.bodyColor;
      ctx.fillRect(drawX-h.w/2,h.y-h.h,h.w,h.h);
      ctx.fillStyle=h.roofColor;
      ctx.beginPath();
      ctx.moveTo(drawX-h.w/2-S(5),h.y-h.h);
      ctx.lineTo(drawX,h.y-h.h-S(40));
      ctx.lineTo(drawX+h.w/2+S(5),h.y-h.h);
      ctx.closePath();
      ctx.fill();
      ctx.save();
      ctx.translate(drawX,h.y-h.h/2+S(10));
      drawPoisonSymbol();
      ctx.restore();
      break;

    case"rock":
      ctx.fillStyle=h.bodyColor;
      ctx.beginPath();
      ctx.moveTo(drawX-h.w/2,h.y);
      ctx.lineTo(drawX-h.w/2+S(10),h.y-h.h*0.6);
      ctx.lineTo(drawX-h.w/2+S(25),h.y-h.h);
      ctx.lineTo(drawX+h.w/3,h.y-h.h*0.7);
      ctx.lineTo(drawX+h.w/2,h.y);
      ctx.closePath();
      ctx.fill();
      break;

    case"tower":
      ctx.fillStyle=h.bodyColor;
      ctx.fillRect(drawX-h.w/2,h.y-h.h,h.w,h.h);
      ctx.fillStyle=h.roofColor;
      ctx.fillRect(drawX-h.w/2+S(10),h.y-h.h-S(15),h.w-S(20),S(15));
      break;

    case"tree":
      ctx.fillStyle="#8B4513";
      ctx.fillRect(drawX-h.w*0.1,h.y-h.h*0.5,h.w*0.2,h.h*0.5);
      ctx.fillStyle=h.bodyColor;
      ctx.beginPath();
      ctx.arc(drawX,h.y-h.h*0.7,h.w*0.6,0,Math.PI*2);
      ctx.fill();
      break;
  }

  ctx.fillStyle="#ff3333";
  ctx.fillRect(drawX-h.w/2,h.y-h.h-S(10),(h.hits/3)*h.w,S(5));
}

function drawPoisonSymbol(){
  ctx.fillStyle="#000";
  ctx.beginPath();
  ctx.arc(0,0,S(14),0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.arc(S(-5),S(-3),S(3),0,Math.PI*2);
  ctx.arc(S(5),S(-3),S(3),0,Math.PI*2);
  ctx.fill();

  ctx.fillRect(S(-6),S(5),S(12),S(3));

  ctx.strokeStyle="#fff";
  ctx.lineWidth=S(2);
  ctx.beginPath();
  ctx.moveTo(S(-14),S(14));
  ctx.lineTo(S(14),S(-14));
  ctx.moveTo(S(-14),S(-14));
  ctx.lineTo(S(14),S(14));
  ctx.stroke();
}

/* ====================== MOBILE BUTTONS ====================== */
const leftBtn=document.getElementById("leftBtn");
const rightBtn=document.getElementById("rightBtn");
function pressKey(code,val){keys[code]=val;}
leftBtn.addEventListener("touchstart",e=>{e.preventDefault();pressKey("ArrowLeft",true);});
leftBtn.addEventListener("touchend",()=>pressKey("ArrowLeft",false));
rightBtn.addEventListener("touchstart",e=>{e.preventDefault();pressKey("ArrowRight",true);});
rightBtn.addEventListener("touchend",()=>pressKey("ArrowRight",false));

update();
</script>
</body>
</html>
